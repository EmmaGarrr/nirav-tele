<!DOCTYPE html>
<html lang="en">
<head>

    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram File Storage</title>
    <!--<link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}">-->

</head>
<body>
    <div class="page-header">
        <h1>Telegram File Storage</h1>
        <div>
            {% if current_user.is_authenticated %}
                <div class="user-info">
                    <span>{{ current_user.username }}</span>
                    {# Optional: Add avatar image here later #}
                    <a href="{{ url_for('logout') }}" class="button" style="background-color:#dc3545;">Logout</a>
                </div>
            {% else %}
                <div>
                    <a href="{{ url_for('login') }}" class="button" style="background-color:#007bff;">Login</a>
                    <a href="{{ url_for('show_register_page') }}" class="button" style="background-color:#28a745;">Sign Up</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Display Flashed Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="padding: 0 20px;">
        {% for category, message in messages %}
          <div class="alert alert-{{ category or 'info' }}" role="alert">
            {{ message }}
          </div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}


    <div class="container">
        <h2>Upload File</h2>
        <div id="drop-zone">
            <p>Drag & Drop file here or click to select</p>
            <input type="file" id="file-input" style="display: none;">
        </div>
        <!-- Upload Progress Display Area -->
        <div id="progress-details" style="display: none; margin-top: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #f9f9f9;">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span id="progress-filename" style="font-weight: bold; word-break: break-all;">filename.zip</span>
                <span><span id="progress-mb-sent" style="color: #007bff;">0.0 MB</span> / <span id="progress-mb-total">0.0 MB</span></span>
             </div>
            <progress id="upload-progress" value="0" max="100" style="width: 100%; height: 10px; margin-bottom: 10px;"></progress>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: #555;">
                 <div>
                    <span title="Estimated Time Remaining">‚è±Ô∏è</span><span id="progress-eta">--:--</span>
                    <span style="margin-left: 15px;" title="Average Speed">‚¨áÔ∏è</span><span id="progress-speed">0.0 MB/s</span>
                 </div>
                 <button id="pause-resume-button" class="progress-button" disabled>‚è∏Ô∏è <span class="button-text">Pause</span></button>
            </div>
        </div>
        <p id="upload-status"></p>
        <div id="share-link-container" style="display: none; margin-top: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #e8f5e8;">
             <label for="share-link-input">Shareable Link:</label>
             <div style="display: flex; align-items: center;">
                 <input type="text" id="share-link-input" readonly style="flex-grow: 1; margin-right: 10px; margin-bottom: 0; background-color: #f0f0f0;">
                 <button id="copy-link-button" class="progress-button" style="padding: 8px 12px;">üìã <span class="button-text">Copy</span></button>
             </div>
             <span id="copy-status" style="font-size: 0.9em; color: green; margin-top: 5px; display: block; height: 1.2em;"></span>
        </div>

        <!-- Upload Button: Enabled state depends on login status (checked in JS) and file selection -->
        <button id="upload-button" disabled {% if not current_user.is_authenticated %}title="Please log in to upload files"{% endif %}>Upload</button>
    </div>

    <div class="container">
        <h2>Stored Files</h2>
        <!-- Username input removed -->

        <!-- List Files Button: Shown only if logged in -->
        {% if current_user.is_authenticated %}
            <button id="list-files-button">List My Files</button>
        {% else %}
            <p>Please log in to see your files.</p>
        {% endif %}
        <ul id="file-list">
            <!-- File list items will be generated here by JavaScript -->
        </ul>
        <p id="list-status"></p> {# Status for listing operation #}

        <!-- Download Prep Details (hidden, used by download_page.html logic potentially, keep structure if needed there) -->
        <div id="download-details" style="display: none; margin-top: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
            {# ... download progress elements ... #}
        </div>
        <p id="download-prep-status" style="display: none;"></p> {# Status specifically for download prep, if needed elsewhere #}
    </div>

    <script>
        // === Element References ===
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status');
        const listFilesButton = document.getElementById('list-files-button'); // Might be null if not logged in
        const fileList = document.getElementById('file-list');
        const listStatus = document.getElementById('list-status');
        const progressDetailsDiv = document.getElementById('progress-details');
        const progressFilenameSpan = document.getElementById('progress-filename');
        const progressMbSentSpan = document.getElementById('progress-mb-sent');
        const progressMbTotalSpan = document.getElementById('progress-mb-total');
        const uploadProgress = document.getElementById('upload-progress');
        const progressEtaSpan = document.getElementById('progress-eta');
        const progressSpeedSpan = document.getElementById('progress-speed');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLinkInput = document.getElementById('share-link-input');
        const copyLinkButton = document.getElementById('copy-link-button');
        const copyStatusSpan = document.getElementById('copy-status');
        // Download prep elements (might be unused on this page now, but keep refs if needed)
        const downloadDetailsDiv = document.getElementById('download-details');
        const downloadPrepStatus = document.getElementById('download-prep-status');

        // === State Variables ===
        let fileToUpload = null;
        let uploadEventSource = null;
        let downloadPrepEventSource = null; // Still needed if prep happens elsewhere? Unlikely now.
        let copyTimeout = null;

        // --- Check if user is logged in (passed from Flask) ---
        // Use Jinja's |tojson filter to safely output true/false as JS literals
        const isLoggedIn = {{ current_user.is_authenticated | tojson }};

        // === Drag/Drop/File Handling ===
        function handleFile(file) {
            fileToUpload = file;
            // Update UI elements safely, checking if they exist
            if(dropZone) dropZone.querySelector('p').textContent = `Selected: ${file.name}`;
            if(uploadButton) uploadButton.disabled = !(fileToUpload && isLoggedIn); // Check login status too
            if(uploadStatus) uploadStatus.textContent = '';
            if(progressDetailsDiv) progressDetailsDiv.style.display = 'none';
            if(uploadProgress) uploadProgress.value = 0;
            if(shareLinkContainer) shareLinkContainer.style.display = 'none';
            if(copyStatusSpan) copyStatusSpan.textContent = '';
            if (uploadEventSource) { uploadEventSource.close(); uploadEventSource = null; }
            // No need to close downloadPrepEventSource here anymore
        }
         if (dropZone) {
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); if(e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
            dropZone.addEventListener('click', () => fileInput?.click());
        }
        if (fileInput) {
            fileInput.addEventListener('change', (e) => { if(e.target.files.length > 0) handleFile(e.target.files[0]); });
        }

        // === Upload Button Logic ===
        if (uploadButton) {
            uploadButton.addEventListener('click', async () => {
                if (!isLoggedIn) {
                     if(uploadStatus) { uploadStatus.textContent = 'Please log in to upload files.'; uploadStatus.style.color = 'red';}
                     return;
                }
                if (!fileToUpload) { if(uploadStatus) { uploadStatus.textContent = 'Please select a file first.'; uploadStatus.style.color = 'red';} return; }

                // UI Updates
                uploadButton.disabled = true;
                if(dropZone) {dropZone.style.pointerEvents = 'none'; dropZone.style.opacity = '0.7';}
                if(uploadStatus) {uploadStatus.textContent = 'Initiating upload...'; uploadStatus.style.color = 'black';}
                if(progressDetailsDiv) progressDetailsDiv.style.display = 'none';
                if(shareLinkContainer) shareLinkContainer.style.display = 'none';
                if(listStatus) listStatus.textContent = ''; // Clear list status

                const formData = new FormData();
                formData.append('file', fileToUpload, fileToUpload.name);
                // No username needed - backend uses session

                try {
                    const response = await fetch('/initiate-upload', { method: 'POST', body: formData });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `HTTP error ${response.status}`);
                    if (result.upload_id) startUploadProgressStream(result.upload_id);
                    else throw new Error("No upload ID received.");
                } catch (error) {
                    console.error('Initiate Upload Error:', error);
                    if(uploadStatus) {uploadStatus.textContent = `Upload Error: ${error.message}`; uploadStatus.style.color = 'red';}
                    if(uploadButton) uploadButton.disabled = !(fileToUpload && isLoggedIn);
                    if(dropZone) { dropZone.style.pointerEvents = 'auto'; dropZone.style.opacity = '1'; }
                }
            });
        }

        // === Upload SSE Handling ===
        function startUploadProgressStream(uploadId) {
            if (uploadEventSource) { uploadEventSource.close(); }
            console.log(`Connecting to UPLOAD SSE stream for upload ID: ${uploadId}`);
            uploadEventSource = new EventSource(`/stream-progress/${uploadId}`);

            uploadEventSource.onopen = function() { /* ... */ };
            uploadEventSource.addEventListener('start', function(event) { /* ... Update progress UI ... */ });
            uploadEventSource.addEventListener('status', function(event) { /* ... Update uploadStatus text ... */ });
            uploadEventSource.addEventListener('progress', function(event) { /* ... Update progress bar, speed, eta ... */ });
            uploadEventSource.addEventListener('complete', function(event) {
                 /* ... Update status, show share link, call finalizeUploadUI(true) ... */
                try {
                    const data = JSON.parse(event.data);
                    if(uploadStatus) { uploadStatus.textContent = data.message || 'Upload Complete!'; uploadStatus.style.color = 'green';}
                    if(uploadProgress) uploadProgress.value = 100;
                    if (data.download_url) {
                        if(shareLinkInput) shareLinkInput.value = data.download_url;
                        if(shareLinkContainer) shareLinkContainer.style.display = 'block';
                        if(copyStatusSpan) copyStatusSpan.textContent = '';
                    } else {
                        if(shareLinkContainer) shareLinkContainer.style.display = 'none';
                    }
                    finalizeUploadUI(true);
                    // Optionally trigger list refresh after successful upload
                     if (isLoggedIn && listFilesButton) {
                         listFilesForCurrentUser();
                     }
                } catch(e) { /* ... error handling ... */ finalizeUploadUI(false);}
            });
            uploadEventSource.addEventListener('error', function(event) { /* ... Update status, call finalizeUploadUI(false) ... */ });
            uploadEventSource.onerror = function(err) { /* ... Handle connection error, call finalizeUploadUI(false) ... */ };
        }
         function finalizeUploadUI(success) {
             if (uploadEventSource) { uploadEventSource.close(); uploadEventSource = null; }
             if (uploadButton) uploadButton.disabled = !(fileToUpload && isLoggedIn);
             if (dropZone) { dropZone.style.pointerEvents = 'auto'; dropZone.style.opacity = '1'; }
             if (pauseResumeButton) pauseResumeButton.disabled = true;
             // Keep share link visible on success, hide progress details after delay
             if(success) {
                 setTimeout(() => { if(progressDetailsDiv) progressDetailsDiv.style.display = 'none'; }, 5000);
             } else {
                 if(progressDetailsDiv) progressDetailsDiv.style.display = 'none';
                 if(shareLinkContainer) shareLinkContainer.style.display = 'none';
             }
        }

        // === Copy Link Logic ===
        if (copyLinkButton) { copyLinkButton.addEventListener('click', () => { /* ... same as before ... */ }); }


        // === **** MODIFIED File Listing Logic **** ===
        async function listFilesForCurrentUser() {
            if (!isLoggedIn) return; // Safety check

            if (fileList) fileList.innerHTML = '';
            if (listStatus) { listStatus.textContent = 'Fetching your files...'; listStatus.style.color = 'black'; listStatus.className = 'info'; } // Use class for status

            try {
                const response = await fetch('/files'); // Fetch for current user
                if (!response.ok) {
                    let errorMsg = `Error fetching files: ${response.statusText} (${response.status})`;
                     try { errorMsg = (await response.json()).error || errorMsg; } catch (e) {}
                     throw new Error(errorMsg);
                }
                const files = await response.json();

                if (!fileList) return; // Exit if file list element doesn't exist

                if (files.length === 0) {
                    if(listStatus) listStatus.textContent = 'You have not uploaded any files yet.'; listStatus.className = 'info';
                    return;
                }

                files.forEach(fileInfo => {
                    if (!fileInfo.access_id) {
                         console.warn("Skipping file record, missing access_id:", fileInfo.original_filename);
                         return; // Skip this record
                    }
                    const li = document.createElement('li');
                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.textContent = fileInfo.original_filename || 'Unknown Filename';

                    const actionsContainer = document.createElement('div');
                    actionsContainer.classList.add('file-actions-buttons');

                    // Download Button (links to /get page)
                    const downloadPageButton = document.createElement('a');
                    downloadPageButton.textContent = 'Download';
                    downloadPageButton.classList.add('download-button'); // Style as button
                    downloadPageButton.href = `/get/${fileInfo.access_id}`; // Use access_id
                    downloadPageButton.target = "_blank"; // Open in new tab

                    // Delete Button
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-button');
                    deleteButton.dataset.accessId = fileInfo.access_id; // Store access_id
                    deleteButton.dataset.filename = fileInfo.original_filename; // For confirm message
                    deleteButton.onclick = (event) => {
                        const accessId = event.target.dataset.accessId;
                        const filename = event.target.dataset.filename;
                        requestDeleteFile(accessId, filename, event.target.closest('li'));
                    };

                    actionsContainer.appendChild(downloadPageButton);
                    actionsContainer.appendChild(deleteButton);
                    li.appendChild(fileNameSpan);
                    li.appendChild(actionsContainer);
                    fileList.appendChild(li);
                });
                if(listStatus) listStatus.textContent = ''; // Clear status on success
            } catch (error) {
                console.error('List files error:', error);
                if(listStatus) { listStatus.textContent = `Error listing files: ${error.message}`; listStatus.style.color = 'red'; listStatus.className = 'error'; }
            }
        }

        // Add listener only if the button exists (i.e., user is logged in)
        if (listFilesButton) {
             listFilesButton.addEventListener('click', listFilesForCurrentUser);
             // Optionally list files automatically when the page loads if logged in
             if (isLoggedIn) {
                 // Use DOMContentLoaded to ensure everything is ready
                 document.addEventListener('DOMContentLoaded', listFilesForCurrentUser);
             }
        }


        // === **** MODIFIED File Deletion Logic **** ===
        async function requestDeleteFile(accessId, filename, listItemElement) {
            if (!isLoggedIn) { // Check auth
                 if(listStatus) { listStatus.textContent = 'Please log in to delete files.'; listStatus.style.color = 'red'; listStatus.className = 'error'; }
                 return;
            }
            if (!confirm(`Are you sure you want to delete the record for "${filename}"? This cannot be undone.`)) {
                return;
            }

            const buttonsInItem = listItemElement.querySelectorAll('button, a');
            buttonsInItem.forEach(btn => { btn.style.pointerEvents = 'none'; btn.style.opacity = '0.5'; });
            if(listStatus) { listStatus.textContent = `Deleting ${filename}...`; listStatus.style.color = 'orange'; listStatus.className = 'info'; }

            try {
                const deleteUrl = `/delete-file/${accessId}`; // Use access_id

                const response = await fetch(deleteUrl, { method: 'DELETE', headers: { 'Accept': 'application/json' }});

                if (response.ok) {
                    const result = await response.json();
                    listItemElement.remove();
                    if(listStatus) { listStatus.textContent = result.message || `Successfully deleted ${filename}.`; listStatus.style.color = 'green'; listStatus.className = 'success'; }
                    setTimeout(() => { if (listStatus && listStatus.textContent.includes(`deleted ${filename}`)) listStatus.textContent = ''; }, 4000);
                } else {
                     let errorMsg = `Failed to delete. Status: ${response.status}`;
                     try { errorMsg = (await response.json()).error || errorMsg; } catch (e) {}
                     console.error('Delete failed:', errorMsg);
                     if(listStatus) { listStatus.textContent = `Error deleting: ${errorMsg}`; listStatus.style.color = 'red'; listStatus.className = 'error'; }
                     buttonsInItem.forEach(btn => { btn.style.pointerEvents = 'auto'; btn.style.opacity = '1'; });
                }
            } catch (error) {
                console.error('Error during delete request:', error);
                if(listStatus) { listStatus.textContent = `Network error deleting file: ${error.message}`; listStatus.style.color = 'red'; listStatus.className = 'error';}
                buttonsInItem.forEach(btn => { btn.style.pointerEvents = 'auto'; btn.style.opacity = '1'; });
            }
        }

        // === Removed old downloadFile function ===

    </script>
</body>
</html>