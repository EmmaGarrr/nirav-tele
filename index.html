<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (keep head section as is) ... -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram File Storage</title>
    <style>
        /* ... (keep styles as is) ... */
    h1, h2 {
    color: #0d0c0c;
    text-align: center;
    margin-bottom: 20px;}

    body {
    font-family: sans-serif;
    line-height: 1.6;
    margin: 200px;
    margin-top: 20px;
    background-color: #d3e8ea;}

    .container {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;}

    label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;}

    input[type="text"],
    input[type="file"] {
    width: calc(100% - 22px); /* Adjust for padding/border */
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #7a7a7a;
    border-radius: 4px;}

    button {
     background-color: #337ab7;
     color: rgb(252, 250, 250);
     padding: 10px 15px;
     border: none;
     border-radius: 4px;
     cursor: pointer;
     font-size: 1em;
     transition: background-color 0.2s ease;}

    button:hover:not(:disabled) {
    background-color: #bebfc7;}

    button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
    }

    #drop-zone {
        border: 2px dashed #9f9f9f;
        border-radius: 4px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        background-color: #f3eeee;
        margin-bottom: 15px;
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    #drop-zone.drag-over {
        border-color: #5cb85c;
        background-color: #e8f5e8;
    }

    #drop-zone p {
        margin: 0;
        color: #7d7c7c;
    }

    #upload-progress {
        margin-top: 10px;
    }

    #upload-status, #list-status {
        margin-top: 10px;
        font-weight: bold;
    }

    #file-list {
        list-style: none;
        padding: 0;
        margin-top: 15px;
    }

    #file-list li {
        background-color: #f9f5f5;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #file-list li span {
        margin-right: 10px;
        word-break: break-all; /* Prevent long filenames from overflowing */
    }

    .download-button {
        background-color: #337ab7;
        padding: 5px 10px;
        font-size: 0.9em;

    }

    .download-button:hover {
        background-color: #286090;
    }

       #upload-progress {
           accent-color: #5cb85c; /* Green progress bar */
       }

       .progress-button { /* Style for Pause/Copy buttons etc */
           background-color: #eee;
           color: #333;
           border: 1px solid #ccc;
           padding: 5px 10px;
           border-radius: 4px;
           cursor: pointer;
           font-size: 0.9em;
           display: inline-flex;
           align-items: center;
       }
       .progress-button:hover:not(:disabled) { background-color: #ddd; }
       .progress-button:disabled { cursor: not-allowed; opacity: 0.6; }
       .progress-button .button-text { margin-left: 5px; }

    .file-actions-buttons {
        display: flex; align-items: center; gap: 5px; margin-left: auto;
    }

    #file-list li { /* Adjusted list item style */
        background-color: #f9f5f5; padding: 10px; margin-bottom: 8px;
        border-radius: 4px; display: flex; align-items: center;
        gap: 10px; /* Adds space between filename and buttons */
    }

    .delete-button { /* Style for delete */
        background-color: #d9534f; color: white; padding: 5px 10px;
        font-size: 0.9em; border: none; border-radius: 4px;
        cursor: pointer; margin-left: 5px; vertical-align: middle;
    }
    .delete-button:hover:not(:disabled) { background-color: #c9302c; }
    .delete-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; }

    /* Ensure download button styles are defined */
    .download-button {
        background-color: #337ab7; color: white; padding: 5px 10px;
        font-size: 0.9em; border: none; border-radius: 4px;
        cursor: pointer; margin-left: 10px; vertical-align: middle;
    }
     .download-button:hover:not(:disabled) { background-color: #286090; }
     .download-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; }


    </style>
</head>
<body>
    <h1>Telegram File Storage</h1>

    <div class="container">
        <h2>Upload File</h2>
        <label for="username">Username:</label>
        <input type="text" id="username" placeholder="Enter your username" required><br><br>

        <div id="drop-zone">
            <p>Drag & Drop file here or click to select</p>
            <input type="file" id="file-input" style="display: none;">
        </div>

                <!-- Progress Display Area - NOW used ONLY for INITIAL UPLOAD -->
                <div id="progress-details" style="display: none; margin-top: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #f9f9f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span id="progress-filename" style="font-weight: bold; word-break: break-all;">filename.zip</span>
                        <span id="progress-text">
                            <span id="progress-mb-sent" style="color:rgb(54, 108, 235)" >0.0 MB</span> / <span id="progress-mb-total" style="color:black">0.0 MB</span>
                        </span>
                    </div>
                    <progress id="upload-progress" value="0" max="100" style="width: 100%; height: 10px; margin-bottom: 10px;"></progress>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: #555;">
                        <div>
                            <span title="Estimated Time Remaining (Uploading)">‚è±Ô∏è</span> <!-- Tooltip changed -->
                            <span id="progress-eta">--:--</span>
                            <span style="margin-left: 15px;" title="Upload Speed">‚¨ÜÔ∏è</span> <!-- Icon changed -->
                            <span id="progress-speed">0.0 MB/s</span>
                        </div>
                         <!-- Pause/Resume for XHR is possible but adds complexity - kept disabled -->
                        <button id="pause-resume-button" class="progress-button" disabled>
                            <span class="pause-icon">‚è∏Ô∏è</span>
                            <span class="button-text">Pause</span>
                        </button>
                         <button id="resume-button" class="progress-button" style="display: none;" disabled>
                            <span class="resume-icon">‚ñ∂Ô∏è</span>
                            <span class="button-text">Resume</span>
                         </button>
                    </div>
                </div>

                <!-- General Status Message Area (Uploading..., Success, Generating Link..., Complete, Errors) -->
                <p id="upload-status" style="margin-top: 10px; font-weight: bold; color:#273c86"></p>

                <!-- Shareable Link Display Area - Hidden Initially -->
                <div id="share-link-container" style="display: none; margin-top: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #e8f5e8;">
                     <!-- (content remains the same) -->
                    <label for="share-link-input" style="font-weight:bold; margin-bottom: 5px;">Shareable Link:</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="share-link-input" readonly style="flex-grow: 1; margin-right: 10px; margin-bottom: 0; background-color: #f0f0f0; border: 1px solid #bbb;">
                        <button id="copy-link-button" class="progress-button" style="padding: 8px 12px;">
                            <span class="copy-icon">üìã</span> <span class="button-text">Copy</span>
                        </button>
                    </div>
                    <span id="copy-status" style="font-size: 0.9em; color: green; margin-top: 5px; display: block; height: 1.2em;"></span>
                </div>

                <!-- Original Upload Button -->
                <button id="upload-button" disabled>Upload</button> <!-- Start disabled -->
    </div>

    <div class="container">
        <h2>Stored Files</h2>
         <!-- (List Files content remains the same) -->
        <label for="list-username">Username to List Files:</label>
        <input type="text" id="list-username" placeholder="Enter username to list files">
        <button id="list-files-button">List Files</button>
        <ul id="file-list"></ul>
        <div id="download-details" style="display: none; margin-top: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #f9f9f9;">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"> <span id="download-filename" style="font-weight: bold; word-break: break-all;">filename.zip</span> <span id="download-prep-progress-text"> <span id="download-prep-mb-processed" style="color: rgb(54, 108, 235);">0.0 MB</span> / <span id="download-prep-mb-total" style="color:black">0.0 MB</span> </span> </div>
             <progress id="download-prep-progress" value="0" max="100" style="width: 100%; height: 10px; margin-bottom: 10px; accent-color: #5cb85c;"></progress>
             <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: #555;"> <div> <span title="Estimated Time Remaining (Preparation)">‚è±Ô∏è</span> <span id="download-prep-eta">--:--</span> <span style="margin-left: 15px;" title="Preparation Speed">‚¨áÔ∏è</span> <span id="download-prep-speed">0.0 MB/s</span> </div> <button id="download-pause-resume-button" class="progress-button" disabled> <span class="pause-icon">‚è∏Ô∏è</span> <span class="button-text">Pause Prep</span> </button> <button id="download-resume-button" class="progress-button" style="display: none;" disabled> <span class="resume-icon">‚ñ∂Ô∏è</span> <span class="button-text">Resume Prep</span> </button> </div>
        </div>
        <p id="download-prep-status" style="margin-top: 10px; font-weight: bold; color: #337ab7; display: none;"></p>
        <p id="list-status"></p>
    </div>

    <script>
        // --- Element References (keep all existing references) ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status'); // Main status message area
        const usernameInput = document.getElementById('username');
        const listUsernameInput = document.getElementById('list-username');
        const listFilesButton = document.getElementById('list-files-button');
        const fileList = document.getElementById('file-list');
        const listStatus = document.getElementById('list-status');
        const downloadPrepStatus = document.getElementById('download-prep-status');

        const progressDetailsDiv = document.getElementById('progress-details'); // Div for INITIAL UPLOAD progress
        const progressFilenameSpan = document.getElementById('progress-filename');
        const progressMbSentSpan = document.getElementById('progress-mb-sent');
        const progressMbTotalSpan = document.getElementById('progress-mb-total');
        const uploadProgress = document.getElementById('upload-progress'); // The progress bar itself
        const progressEtaSpan = document.getElementById('progress-eta');
        const progressSpeedSpan = document.getElementById('progress-speed');
        const pauseResumeButton = document.getElementById('pause-resume-button'); // Pause button (currently disabled)

        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLinkInput = document.getElementById('share-link-input');
        const copyLinkButton = document.getElementById('copy-link-button');
        const copyStatusSpan = document.getElementById('copy-status');

        const downloadDetailsDiv = document.getElementById('download-details');
        const downloadFilenameSpan = document.getElementById('download-filename');
        // ...(other download elements remain the same)...
        const downloadPrepProgressTextSpan = document.getElementById('download-prep-progress-text');
        const downloadPrepMbProcessedSpan = document.getElementById('download-prep-mb-processed');
        const downloadPrepMbTotalSpan = document.getElementById('download-prep-mb-total');
        const downloadPrepProgress = document.getElementById('download-prep-progress');
        const downloadPrepEtaSpan = document.getElementById('download-prep-eta');
        const downloadPrepSpeedSpan = document.getElementById('download-prep-speed');
        const downloadPauseResumeButton = document.getElementById('download-pause-resume-button');


        // --- State Variables ---
        let fileToUpload = null;
        let uploadEventSource = null; // SSE connection for UPLOAD (GENERATING LINK phase)
        let downloadPrepEventSource = null; // SSE connection for DOWNLOAD PREPARATION status
        let copyTimeout = null; // To manage the "Copied!" message timeout
        let xhr = null; // Variable to hold the XMLHttpRequest object for cancellation (optional)


        // --- Helper: Format Time (Add if not present or use backend format) ---
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0 || !isFinite(seconds)) return "--:--";
            seconds = Math.round(seconds);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hours > 0) { return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; }
            else { return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; }
        }

        // --- Drag and Drop Logic (keep as is) ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); const files = e.dataTransfer.files; if (files.length > 0) { handleFile(files[0]); } });
        dropZone.addEventListener('click', () => { fileInput.click(); });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { handleFile(e.target.files[0]); } });

        // --- Handle File Selection (Reset UI and close connections) ---
        function handleFile(file) {
            console.log("Handling file selection:", file.name);
            fileToUpload = file;
            dropZone.querySelector('p').textContent = `Selected: ${file.name}`;
            uploadButton.disabled = !usernameInput.value.trim();
            uploadStatus.textContent = '';
            progressDetailsDiv.style.display = 'none'; // Hide initial upload progress
            shareLinkContainer.style.display = 'none';
            copyStatusSpan.textContent = '';

            if (uploadEventSource) { uploadEventSource.close(); uploadEventSource = null; console.log("Closed UPLOAD SSE connection."); }
            if (downloadPrepEventSource) { downloadPrepEventSource.close(); downloadPrepEventSource = null; console.log("Closed DOWNLOAD PREP SSE."); downloadDetailsDiv.style.display = 'none'; downloadPrepStatus.style.display = 'none'; }
            if (xhr) { xhr.abort(); xhr = null; console.log("Aborted previous XHR upload."); } // Abort previous XHR if running

            usernameInput.disabled = false;
            dropZone.style.pointerEvents = 'auto';
            dropZone.style.opacity = '1';
        }

        // --- Enable upload button ---
         usernameInput.addEventListener('input', () => {
            uploadButton.disabled = !(usernameInput.value.trim() && fileToUpload);
         });


        // --- Upload Button Logic (Using XMLHttpRequest for Initial Upload) ---
        uploadButton.addEventListener('click', () => { // Removed 'async' as XHR uses callbacks
            if (!fileToUpload) { /* ... (validation as before) ... */ return; }
            const username = usernameInput.value.trim();
            if (!username) { /* ... (validation as before) ... */ return; }

            // --- UI Update: Start Initial Upload ---
            uploadButton.disabled = true;
            usernameInput.disabled = true;
            dropZone.style.pointerEvents = 'none';
            dropZone.style.opacity = '0.7';
            uploadStatus.textContent = 'Uploading file...'; // Main status
            uploadStatus.style.color = '#337ab7';
            shareLinkContainer.style.display = 'none'; // Hide link area
            copyStatusSpan.textContent = '';
            downloadPrepStatus.style.display = 'none'; // Hide download prep status

            // --- Prepare and Show INITIAL Upload Progress Bar ---
            progressFilenameSpan.textContent = fileToUpload.name;
            const totalSize = fileToUpload.size;
            progressMbTotalSpan.textContent = `${(totalSize / (1024 * 1024)).toFixed(1)} MB`;
            progressMbSentSpan.textContent = '0.0 MB';
            uploadProgress.value = 0;
            progressEtaSpan.textContent = '--:--';
            progressSpeedSpan.textContent = '0.0 MB/s';
            pauseResumeButton.disabled = true; // Keep disabled for now
            progressDetailsDiv.style.display = 'block'; // <<< SHOW progress bar for initial upload

            // --- Use XMLHttpRequest ---
            const formData = new FormData();
            formData.append('file', fileToUpload, fileToUpload.name);
            formData.append('username', username);

            xhr = new XMLHttpRequest(); // Assign to global scope for potential cancellation
            const uploadStartTime = Date.now();

            // --- XHR Progress Handler (for Browser -> Server upload) ---
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const bytesSent = event.loaded;
                    const totalBytes = event.total; // Use event.total, should match fileToUpload.size
                    const percentage = Math.min(Math.max((bytesSent / totalBytes) * 100, 0), 100);
                    uploadProgress.value = percentage;

                    const sentMB = (bytesSent / (1024 * 1024)).toFixed(1);
                    const totalMB = (totalBytes / (1024 * 1024)).toFixed(1);
                    progressMbSentSpan.textContent = `${sentMB} MB`;
                    progressMbTotalSpan.textContent = `${totalMB} MB`; // Update total just in case

                    const elapsedSeconds = (Date.now() - uploadStartTime) / 1000;
                    let speed = 0;
                    let etaFormatted = '--:--';
                    if (elapsedSeconds > 0.1 && bytesSent > 0) {
                        const speedBps = bytesSent / elapsedSeconds;
                        speed = speedBps / (1024 * 1024); // Speed in MB/s
                        const remainingBytes = totalBytes - bytesSent;
                        if (remainingBytes > 0 && speedBps > 0) {
                            const etaSeconds = remainingBytes / speedBps;
                            etaFormatted = formatTime(etaSeconds);
                        } else if (bytesSent >= totalBytes) {
                            etaFormatted = '00:00'; // Done
                        }
                    }
                    progressSpeedSpan.textContent = `${speed.toFixed(2)} MB/s`;
                    progressEtaSpan.textContent = etaFormatted;
                } else {
                    // Cannot compute progress, maybe show indeterminate state?
                    uploadProgress.removeAttribute('value'); // Indeterminate progress bar
                    progressMbSentSpan.textContent = '? MB';
                    progressEtaSpan.textContent = '--:--';
                    progressSpeedSpan.textContent = '? MB/s';
                }
            };

            // --- XHR Load Handler (Upload to Temp Folder Complete) ---
            xhr.onload = function() {
                 // Ensure progress shows 100% on successful load, regardless of final onprogress event
                uploadProgress.value = 100;
                progressMbSentSpan.textContent = progressMbTotalSpan.textContent; // Show full size sent
                progressEtaSpan.textContent = '00:00';

                if (xhr.status === 200) {
                    // --- SUCCESSFUL Initial Upload ---
                    console.log("Initial XHR upload complete (Status 200).");
                    progressDetailsDiv.style.display = 'none'; // <<< HIDE progress bar NOW
                    uploadStatus.textContent = 'File uploaded successfully. Generating link...'; // Transition message
                    uploadStatus.style.color = 'green'; // Success color

                    try {
                        const result = JSON.parse(xhr.responseText);
                        if (result.upload_id) {
                             console.log(`Received upload_id: ${result.upload_id}. Starting SSE stream...`);
                             // Start SSE for background status updates (NO progress bar)
                             startUploadProgressStream(result.upload_id);
                        } else {
                             throw new Error("Server response missing upload ID after successful upload.");
                        }
                    } catch (e) {
                         console.error("Error parsing server response:", e, xhr.responseText);
                         uploadStatus.textContent = 'Error: Invalid server response after upload.';
                         uploadStatus.style.color = 'red';
                         finalizeUploadUI(false); // Reset UI on parse error
                    }
                } else {
                    // Handle HTTP errors from /initiate-upload
                    console.error(`Initial upload failed. Status: ${xhr.status}, Response: ${xhr.responseText}`);
                    let errorMsg = `Upload failed (Server Error: ${xhr.status})`;
                    try { const errData = JSON.parse(xhr.responseText); errorMsg = errData.error || errorMsg; } catch(e){}
                    uploadStatus.textContent = `Error: ${errorMsg}`;
                    uploadStatus.style.color = 'red';
                    progressDetailsDiv.style.display = 'none'; // Hide progress on error
                    finalizeUploadUI(false); // Reset UI on error
                }
                xhr = null; // Clear XHR object
            };

            // --- XHR Error Handlers ---
            xhr.onerror = function() {
                console.error("XHR onerror triggered (Network error during initial upload).");
                uploadStatus.textContent = 'Error: Network error during upload.';
                uploadStatus.style.color = 'red';
                progressDetailsDiv.style.display = 'none'; // Hide progress
                finalizeUploadUI(false); // Reset UI
                xhr = null;
            };
            xhr.ontimeout = function() {
                console.error("XHR ontimeout triggered.");
                uploadStatus.textContent = 'Error: Upload timed out.';
                uploadStatus.style.color = 'red';
                progressDetailsDiv.style.display = 'none'; // Hide progress
                finalizeUploadUI(false); // Reset UI
                xhr = null;
            };
            xhr.onabort = function() {
                 console.log("XHR upload aborted.");
                 // finalizeUploadUI(false); // Reset UI maybe needed if triggered externally
                 xhr = null;
            }

            // --- Send the request ---
            try {
                xhr.open('POST', '/initiate-upload', true);
                // xhr.timeout = 300000; // Optional: Set timeout in ms (e.g., 5 minutes)
                xhr.send(formData);
                console.log("XHR request sent to /initiate-upload.");
            } catch (error) { // Catch potential errors during xhr.send itself
                console.error("Error sending XHR request:", error);
                uploadStatus.textContent = `Error starting upload: ${error.message}`;
                uploadStatus.style.color = 'red';
                progressDetailsDiv.style.display = 'none'; // Hide progress
                finalizeUploadUI(false); // Reset UI
                xhr = null; // Clear XHR object
            }

        }); // End of uploadButton click listener

        // --- Function to handle UPLOAD Server-Sent Events (Generating Link Phase - NO PROGRESS BAR) ---
        function startUploadProgressStream(uploadId) {
            if (uploadEventSource) { uploadEventSource.close(); console.log("Closed existing UPLOAD EventSource."); }

            console.log(`Connecting to UPLOAD SSE stream for background status (upload ID: ${uploadId})`);
            uploadEventSource = new EventSource(`/stream-progress/${uploadId}`);

            uploadEventSource.onopen = function() {
                console.log("UPLOAD SSE connection opened (for background status).");
                // Status is likely already "Generating link...", no need to change it here unless desired
                shareLinkContainer.style.display = 'none';
                copyStatusSpan.textContent = '';
            };

            // Listener for 'start' event (Backend signals background processing started)
            uploadEventSource.addEventListener('start', function(event) {
                 console.log("UPLOAD SSE 'start' event received (background processing):", event.data);
                 // ** STEP 2 CHANGE: DO NOTHING with progress bar here **
                 // We just log that the backend confirmed starting the background work.
                 // The status message should already be "Generating link..." or updated by a 'status' event.
                 try {
                     const data = JSON.parse(event.data);
                     // Optionally use data.filename for context if needed elsewhere
                 } catch (e) { console.error("Error parsing 'start' event:", e); }
            });

            // Listener for 'status' events (Updating the text message)
            uploadEventSource.addEventListener('status', function(event) {
               console.log("UPLOAD SSE 'status' event received:", event.data);
                try {
                    const data = JSON.parse(event.data);
                    uploadStatus.textContent = data.message || 'Generating link...'; // Update main status text
                } catch (e) { console.error("Error parsing 'status' event:", e); }
            });

            // *** STEP 2 CHANGE: REMOVE 'progress' listener entirely ***
            // The backend no longer sends these, and we don't show a progress bar for this phase.
            // uploadEventSource.addEventListener('progress', function(event) { ... }); // REMOVED

            // Listener for 'complete' event (Link is ready)
            uploadEventSource.addEventListener('complete', function(event) {
                console.log("UPLOAD SSE 'complete' event received:", event.data);
                try {
                    const data = JSON.parse(event.data);
                    // *** Update status, show link ***
                    uploadStatus.textContent = data.message || 'Link generated successfully!';
                    uploadStatus.style.color = 'green';
                    // progressDetailsDiv remains hidden

                    if (data.download_url) {
                        console.log("Received Download URL:", data.download_url);
                        shareLinkInput.value = data.download_url;
                        shareLinkContainer.style.display = 'block'; // Show link container
                        copyStatusSpan.textContent = '';
                    } else { /* ... (handle missing URL as before) ... */ }

                    finalizeUploadUI(true); // Clean up UI state (closes SSE)

                } catch (e) { /* ... (handle complete parse error as before) ... */ }
            });

            // Listener for 'error' events from the stream
            uploadEventSource.addEventListener('error', function(event) {
                console.error("UPLOAD SSE 'error' event received:", event.data);
                let errorMsg = 'An error occurred during link generation.';
                 try { /* ... (parse error message if possible) ... */ } catch(e) {}
                uploadStatus.textContent = errorMsg;
                uploadStatus.style.color = 'red';
                // progressDetailsDiv remains hidden
                shareLinkContainer.style.display = 'none';
                finalizeUploadUI(false); // Reset UI state (closes SSE)
            });

           // Handle generic SSE errors
           uploadEventSource.onerror = function(err) {
               console.error("UPLOAD EventSource connection error:", err);
               if (uploadEventSource) { // Check if connection object exists
                    // Avoid showing error if WE closed it (readyState CLOSED)
                   if(uploadEventSource.readyState !== EventSource.CLOSED) {
                       uploadStatus.textContent = 'Connection error during link generation.';
                       uploadStatus.style.color = 'red';
                       // progressDetailsDiv remains hidden
                       shareLinkContainer.style.display = 'none';
                       finalizeUploadUI(false); // Reset UI state (closes SSE)
                   } else {
                        console.log("UPLOAD EventSource onerror skipped (connection closed).");
                   }
               } else { console.log("UPLOAD EventSource onerror skipped (no SSE object)."); }

                // Ensure SSE object is nullified after error/closure
                if (uploadEventSource) { uploadEventSource.close(); uploadEventSource = null; }
           };
       } // --- End of startUploadProgressStream ---


       // --- Copy Button Functionality (keep as is) ---
       copyLinkButton.addEventListener('click', () => { /* ... */ const linkToCopy = shareLinkInput.value; if (!linkToCopy) return; navigator.clipboard.writeText(linkToCopy).then(() => { copyStatusSpan.textContent = 'Copied!'; if (copyTimeout) clearTimeout(copyTimeout); copyTimeout = setTimeout(() => { copyStatusSpan.textContent=''; copyTimeout=null; }, 3000); }).catch(err => { console.error('Failed to copy link: ', err); copyStatusSpan.textContent = 'Copy failed!'; copyStatusSpan.style.color = 'red'; if (copyTimeout) clearTimeout(copyTimeout); copyTimeout = setTimeout(() => { copyStatusSpan.textContent=''; copyStatusSpan.style.color='green'; copyTimeout=null; }, 3000); }); });

       // --- Helper function to reset UI after UPLOAD processing finishes or fails ---
       function finalizeUploadUI(success) {
            // Ensure SSE connection is closed if it exists
            if (uploadEventSource) {
                uploadEventSource.close();
                uploadEventSource = null;
                console.log("UPLOAD EventSource closed in finalizeUploadUI.");
            }
            // Ensure XHR is aborted and cleared if it somehow still exists
            if (xhr) {
                xhr.abort();
                xhr = null;
                console.log("XHR aborted in finalizeUploadUI.");
            }

            // Re-enable controls
            usernameInput.disabled = false;
            dropZone.style.pointerEvents = 'auto';
            dropZone.style.opacity = '1';
            uploadButton.disabled = !(usernameInput.value.trim() && fileToUpload);
            pauseResumeButton.disabled = true;

            // --- Ensure Initial Upload Progress Bar is Hidden ---
            progressDetailsDiv.style.display = 'none'; // Make sure it's hidden

            if(success) {
                 // On success, status message and share link are already handled by 'complete' listener
            } else {
                 // On error, status message is handled by error listeners. Ensure link is hidden.
                 shareLinkContainer.style.display = 'none';
            }
       } // --- End of finalizeUploadUI ---


        // --- List Files Logic (keep as is) ---
        listFilesButton.addEventListener('click', () => { 
            console.log("DEBUG: List Files button clicked."); 
            const username = listUsernameInput.value.trim(); 
            console.log("DEBUG: Username entered: '${username}'");
            if (!username) {
                listStatus.textContent = 'Please enter a username to list files.';
                listStatus.style.color = 'red';
                console.log("DEBUG: No username entered, stopping.");
                return;
            }
            console.log(`DEBUG: Calling listFiles function for username: ${username}`);
            listFiles(username);
        });
        async function listFiles(username) {
            console.log(`DEBUG: Inside listFiles function for username: ${username}`);
            fileList.innerHTML = '';
            listStatus.textContent = 'Fetching file list...';
            listStatus.style.color = 'black';
            if (downloadPrepStatus) downloadPrepStatus.style.display = 'none';

            try {
                const fetchUrl = `/files/${encodeURIComponent(username)}`;
                console.log(`DEBUG: Attempting to fetch: ${fetchUrl}`);
                const response = await fetch(fetchUrl);
                console.log(`DEBUG: Fetch response status: ${response.status}`);

                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                     try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) {}
                     console.error(`DEBUG: Fetch error: ${errorMsg}`);
                     throw new Error(errorMsg);
                }
                const files = await response.json();
                console.log(`DEBUG: Received files data from backend:`, files);

                if (files.length === 0) {
                    listStatus.textContent = 'No files found for this user.';
                    console.log(`DEBUG: No files found for user '${username}'.`);
                    return;
                }

                files.forEach(fileInfo => {
                   console.log(`DEBUG: Adding file to list: ${fileInfo.original_filename}`);
                   const li = document.createElement('li');
                   const fileNameSpan = document.createElement('span');
                   fileNameSpan.textContent = fileInfo.original_filename;

                   const actionsContainer = document.createElement('div');
                   actionsContainer.classList.add('file-actions-buttons');

                   // --- Download Button ---
                   const downloadButton = document.createElement('button');
                   downloadButton.textContent = 'Download';
                   downloadButton.classList.add('download-button');
                   downloadButton.dataset.username = username; // Use the correct username for the row
                   downloadButton.dataset.filename = fileInfo.original_filename;

                   // *** STEP 1 CHANGE: Use addEventListener instead of onclick ***
                   downloadButton.addEventListener('click', (event) => {
                       // 'this' inside here refers to the button itself if needed,
                       // but event.target is usually preferred
                       const buttonElement = event.currentTarget; // Use currentTarget for the element listener is attached to
                       const user = buttonElement.dataset.username;
                       const file = buttonElement.dataset.filename;
                       console.log(`DEBUG: Download clicked for user: ${user}, file: ${file}`);
                       downloadFile(user, file);
                   });
                   // downloadButton.onclick = (event) => { ... }; // <-- REMOVED THIS LINE

                    // --- Delete Button ---
                   const deleteButton = document.createElement('button');
                   deleteButton.textContent = 'Delete';
                   deleteButton.classList.add('delete-button');
                   deleteButton.dataset.username = username; // Use the correct username for the row
                   deleteButton.dataset.filename = fileInfo.original_filename;

                   // *** STEP 1 CHANGE: Use addEventListener instead of onclick ***
                   deleteButton.addEventListener('click', (event) => {
                       const buttonElement = event.currentTarget;
                       const user = buttonElement.dataset.username;
                       const file = buttonElement.dataset.filename;
                       const listItem = buttonElement.closest('li'); // Find parent li relative to the clicked button
                       if (!listItem) {
                           console.error("Could not find parent list item for delete button!");
                           return;
                       }
                       console.log(`DEBUG: Delete clicked for user: ${user}, file: ${file}`);
                       requestDeleteFile(user, file, listItem);
                   });
                   // deleteButton.onclick = (event) => { ... }; // <-- REMOVED THIS LINE


                   actionsContainer.appendChild(downloadButton);
                   actionsContainer.appendChild(deleteButton);

                   li.appendChild(fileNameSpan);
                   li.appendChild(actionsContainer);

                   fileList.appendChild(li);
                });
                listStatus.textContent = ''; // Clear status on success
            } catch (error) {
                console.error('List files error:', error);
                listStatus.textContent = `Error listing files: ${error.message}`;
                listStatus.style.color = 'red';
            }
        }

        // --- Download File Preparation Logic (keep as is) ---
         async function downloadFile(username, filename) { /* ... (no changes needed) ... */ }

        // --- Delete File Logic (keep as is) ---
        async function requestDeleteFile(username, filename, listItemElement) { /* ... (no changes needed) ... */ }

    </script>
</body>
</html>